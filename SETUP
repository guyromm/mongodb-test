#our shards internal ips:
#mongo1: 
10.181.238.238
#mongo2: 
10.181.239.133
#mongo3: 
10.181.236.72

#mongos coordinator listens on 10000
mongos --port 10000 --configdb 10.181.239.133:9999

#the following is done at mongos: mongo 10.181.239.133:10000/admin

var maxsize=1500;

db.runCommand({addshard:"10.181.238.238:27017",maxSize:maxsize,name:"mongo1"});
db.runCommand({addshard:"10.181.239.133:27017",maxSize:maxsize,name:"mongo2"});
db.runCommand({addshard:"10.181.236.72:27017",maxSize:maxsize,name:"mongo3"});

#the rest of them:
var onodes = ['10.181.230.130',
    '10.181.228.196','10.181.229.16','10.181.226.204','10.181.229.195','10.181.228.74','10.181.226.130',
    '10.181.226.118','10.181.230.39','10.181.227.43','10.181.227.122','10.181.227.59',
    '10.181.230.69','10.181.230.67','10.181.226.124','10.181.224.243','10.181.230.216'];
for (var i=0;i<onodes.length;i++) db.runCommand({addshard:onodes[i],maxSize:maxsize,name:"extrashard"+i});

db.runCommand({enablesharding:"test_database"});
var colname = 'sharded_20nodes';
db.runCommand({shardcollection:"test_database."+colname,key:{indexed_id:1}});

var l = '0123456790abcdef';var nn = 1; var cnt=0;
for (var x=0;x<l.length;x++) for(var y=0;y<l.length;y+=nn)  for (var z=0;z<l.length;z+=nn*3){print(l[x]+l[y]+l[z]); cnt++; }
    {

             db.runCommand({split:"test_database."+colname,middle:{indexed_id:l[x]+l[y]+l[z] } });
	     }
print(cnt);

#quickkk shard distribution :D
var d = db.shards.find({},{_id:1}).toArray();
var c = db.chunks.find().toArray();
var shid=0;
for (chid in c) {
    if (shid>=d.length) shid=0;
    print ("assigning shard "+d[shid]._id+" to chunk "+chid);
    c[chid].shard = d[shid]._id;
    db.chunks.save(c[chid]);
    shid++;
	}
	 #clean launch sequence:
	 rm -rf /var/lib/mongocfg /var/lib/mongodb ; mkdir /var/lib/mongocfg /var/lib/mongodb ; cd mongodb-test ; git pull ; screen -S master -c mongodb-test.screen

	 #run on a single instance
	 python test_controllers.py '/insert/100k/50?noindex=1&sleep=0&collection=mongo1_single&initialindex=1'

	 #run on a sharded cluster
	 python test_controllers.py '/insert/100k/50?noindex=1&sleep=0&collection=sharded_3nodes&initialindex=1'

	 #run 30m on a 10 node sharded cluster
	 python test_controllers.py '/insert/100k/300?noindex=1&sleep=0&collection=sharded_10nodes&initialindex=1'

	 #run 30m on a 10 node sharded cluster
	 python test_controllers.py '/insert/100k/300?noindex=1&sleep=0&collection=sharded_20nodes&initialindex=1'